<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Feel Outside The Box</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="css/site.css" />
        <script type="text/javascript" src="js/enchant/enchant.js"></script>
        <script type="text/javascript" src="js/jquery/jquery-1.11.0.js"></script>
    </head>
    <body>
        <div id="header"><h1>Feel Outside The Box</h1></div>
        <hr />
        <div id="content">
            <div id="enchant-stage"></div>
        </div>
        <hr />
        <div id="footer">
            <ul>
                <li>
                    <span class="credits_title">Credits:</span>
                    <ul>
                        <li>Coded by <span class="credit">Katariina Pohjola</span> and <span class="credit">Mikko Sairo</span></li>
                        <li>Graphics by <span class="credit">Muura Parkkinen</span> and <span class="credit">Mira INSERTNAMEHERE</span></li>
                        <li>Audio by <span class="credit">Tapani INSERTNAMEHERE</span> and <span class="credit">INSERTNAMEHERE INSERTNAMEHERE</span></li>
                    </ul>
                </li>
            </ul>
        </div>
        <script type="text/javascript">
            var gamediv = $('#enchant-stage');
            window.onload = function() {
                enchant();
                
                var game = new Game(1024,600);
                game.preload('img/kissa.png', // NPCs
                             'img/tipu_1000x732.gif',
                             'img/laatikkohahmoW526.png',
                             'img/koalaW917.png',
                             'img/roskisW930.png',
                             'img/mummo-619-x-850b.gif',
                             'img/kentta_5000.gif', // UI and other objects
                             'img/title.gif',
                             'img/viivaW176.png',
                             'img/ajatusW142.png',
                             'img/kuplaW958.png');
                game.onload = function() {
                    game.scale = 1;
                    game.fps = 25;
                    game.scenes = new Object();
                    
                    var startScene = new StartScene();
                    game.scenes.start = startScene;
                    
                    game.pushScene(game.scenes.start);
                };
                
                game.start();
                
                var StartScene = Class.create(Scene, {
                    game: Game.instance,
                    initialize: function() {
                        Scene.apply(this);
                        
                        this.backgroundColor = '#aaaaaa';
                        /*
                        this.world = new World(5000, 5000, 'img/kentta_5000.gif');
                        this.addChild(this.world);
                        
                        this.title = new TitleLabel("Feel Outside The Box");
                        this.title.y = 50;
                        this.title.font = "32px Comic Sans MS";
                        this.addChild(this.title);
                        
                        this.subtitle = new TitleLabel("FGJ2014 - Pohjois-Karjala");
                        this.subtitle.y = 150;
                        this.subtitle.color = 'red';
                        this.addChild(this.subtitle);
                        
                        this.subtitle = new TitleLabel("Credits:\r\nNukiuchi, Katariina Pohjola, Muura, Myla");
                        this.subtitle.y = 250;
                        this.subtitle.color = 'blue';
                        this.addChild(this.subtitle);
                        
                        this.char = new Character(781,602);
                        this.addChild(this.char);
                        */
                        this.title = new Sprite(1024,600);
                        this.title.image = game.assets['img/title.gif'];
                        this.title.frame = [0,1,2];
                        this.addChild(this.title);
                        
                        this.addEventListener(Event.TOUCH_START, this.onTouchStart);
                        this.addEventListener(Event.ENTER_FRAME, this.onEnterFrame);
                    },

                    onTouchStart: function(e) {
                        var gameScene = new GameScene();
                        game.scenes.game = gameScene;
                    
                        game.replaceScene(game.scenes.game);
                    },
                    onEnterFrame: function(e) {
                        //this.char.onEnterFrame(e);
                        //this.world.rotate(-0.1);
                    }
                });
                
                var GameScene = Class.create(Scene, {
                    game: Game.instance,
                    initialize: function() {
                        Scene.apply(this);
                        
                        // Define the background or "world" object
                        this.world = new World(5000, 5000, 'img/kentta_5000.gif');
                        this.addChild(this.world);
                        this.originX = this.world.x;
                        this.backgroundColor = '#112255';
                        
                        // Define different GameObjects, or NPCs
                        this.npcs = new Array();
                        
                        var cat = new GameObject(765,1984, 'img/kissa.png');
                        cat.distance = 1760;
                        cat.rotate(15);
                        
                        var catEvent = new GameEvent();
                        catEvent.initialText = "Hello world!";
                        var option1 = new Option("What a nice day!");
                        var o1_answer1 = new Answer("Go away.", Types.sad, 2);
                        var o1_answer2 = new Answer("Indeed it is!", Types.happy, 2);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("Go away.");
                        var o2_answer1 = new Answer("Same to you.", Types.angry, 2);
                        var o2_answer2 = new Answer("Fine.", Types.angry, 2);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("What a nice day!");
                        var o3_answer1 = new Answer("Go away.", Types.sad, 2);
                        var o3_answer2 = new Answer("Indeed it is!", Types.happy, 2);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        catEvent.options.push(option1);
                        catEvent.options.push(option2);
                        catEvent.options.push(option3);
                        
                        cat.event = catEvent;
                        this.addChild(cat);
                        this.npcs.push(cat);
                        
                        var coala = new GameObject(917,1084, 'img/koalaW917.png');
                        coala.distance = 1800;
                        coala.rotate(cat.rotation + 45);
                        this.addChild(coala);
                        this.npcs.push(coala);
                        
                        var boxguy = new GameObject(526, 1373, 'img/laatikkohahmoW526.png');
                        boxguy.distance = 1800;
                        boxguy.rotate(coala.rotation + 50);
                        this.addChild(boxguy);
                        this.npcs.push(boxguy);
                        
                        var trashbin = new GameObject(930, 1272, 'img/roskisW930.png');
                        trashbin.distance = 1808;
                        trashbin.rotate(boxguy.rotation + 50);
                        this.addChild(trashbin);
                        this.npcs.push(trashbin);
                        
                        var granny = new GameObject(619, 850, 'img/mummo-619-x-850b.gif');
                        granny.distance = 1830;
                        granny.scaleX = 0.2;
                        granny.scaleY = 0.2;
                        granny.rotate(trashbin.rotation + 50);
                        this.addChild(granny);
                        this.npcs.push(granny);
                        
                        var cat = new GameObject(765,1984, 'img/kissa.png');
                        cat.distance = 1760;
                        cat.rotate(15);
                        this.addChild(cat);
                        this.npcs.push(cat);
                        
                        trashbin = new GameObject(930, 1272, 'img/roskisW930.png');
                        trashbin.distance = 1808;
                        trashbin.rotate(granny.rotation + 50);
                        this.addChild(trashbin);
                        this.npcs.push(trashbin);
                        
                        
                        // Define the Player Character
                        this.char = new Character(781,602);
                        this.char.frame = [null];
                        this.addChild(this.char);
                        
                        // Define UI
                        this.clock = new Clock();
                        this.clock.timeSpeed = 3;
                        this.addChild(this.clock);
                        
                        // Define Game UI Objects
                        
                        this.ui = new Array();
                        
                        this.charChat = new ChatBubble(this, this.char, "Hello world! This is going to be a long-ish     text. Let's make it even longer just to make  it longer.");
                        this.charChat.show();
                        this.charChat.updatePosition(this.world);
                        
                        // Event bindings
                        this.addEventListener(Event.TOUCH_START, this.onTouchStart);
                        this.addEventListener(Event.ENTER_FRAME, this.onEnterFrame);
                        this.addEventListener(Event.RIGHT_BUTTON_DOWN, this.onRightButtonDown);
                        this.addEventListener(Event.RIGHT_BUTTON_UP, this.onRightButtonUp);
                        this.addEventListener(Event.LEFT_BUTTON_DOWN, this.onLeftButtonDown);
                        this.addEventListener(Event.LEFT_BUTTON_UP, this.onLeftButtonUp);
                        
                        // Flags for input and timers
                        this.rightButtonDown = false;
                        this.leftButtonDown = false;
                        this.timeElapsedObjects = 0;
                        this.timeElapsedChar = 0;
                        
                        // Variables for game speed and such
                        this.charUpdateSpeed = 0.01;
                        this.objectUpdateSpeed = 0.1;
                        this.worldRotationSpeed = 0.15;
                        this.collisionDistance = 100;
                        
                        // Initialize objects
                        this.rotateObjects(0);
                    },
                    updateSkyColor: function() {
                        var hours = this.clock.hours;
                        if(hours > 22 || hours < 6) {
                            // Night
                            this.backgroundColor = '#000011';
                        } else if(hours >= 6 && hours < 11) {
                            switch(hours) {
                                case 6:
                                    this.backgroundColor = '#111122';
                                    break;
                                case 7:
                                    this.backgroundColor = '#337777';
                                    break;
                                case 8:
                                    this.backgroundColor = '#559999';
                                    break;
                                case 9:
                                    this.backgroundColor = '#77BBBB';
                                    break;
                                case 10:
                                    this.backgroundColor = '#99DDDD';
                                    break;
                            }
                        } else if(hours >= 18 && hours <= 22) {
                            switch(hours) {
                                case 18:
                                    this.backgroundColor = '#99DDDD';
                                    break;
                                case 19:
                                    this.backgroundColor = '#77BBBB';
                                    break;
                                case 20:
                                    this.backgroundColor = '#559999';
                                    break;
                                case 21:
                                    this.backgroundColor = '#225555';
                                    break;
                                case 22:
                                    this.backgroundColor = '#111122';
                                    break;
                            }
                        } else {
                            // Day
                            this.backgroundColor = '#BBFFFF';
                        }
                    },
                    
                    rotateObjects: function(degrees) {
                        this.world.rotate(degrees);
                        for(var i=0;i<this.npcs.length; i++) {
                            this.npcs[i].rotate(degrees);
                            this.npcs[i].updatePosition(this.world);
                        }
                        for(i=0;i<this.ui.length; i++) {
                            this.ui[i].rotate(degrees);
                            this.ui[i].updatePosition(this.world);
                        }
                    },
                    
                    animateObjects: function(elapsed) {
                        this.timeElapsedObjects += elapsed * 0.001;
                        if(this.timeElapsedObjects >= this.objectUpdateSpeed) {
                            for(var i=0;i<this.npcs.length; i++) {
                                this.npcs[i].frame++;
                            }
                            this.timeElapsedObjects -= this.objectUpdateSpeed;
                        }
                    },
                    
                    animateChar: function(elapsed) {
                        this.timeElapsedChar += elapsed * 0.001;
                        if(this.timeElapsedChar >= this.charUpdateSpeed) {
                            this.char.frame++;
                            this.timeElapsedChar -= this.charUpdateSpeed;
                        }
                    },
                    checkCollision: function() {
                        for(var i=0;i<this.npcs.length;i++) {
                            if(this.char.within(this.npcs[i], this.collisionDistance)) {
                                return this.npcs[i];
                            }
                        }
                        return null;
                    },
                    onTouchStart: function(e) {
                        //game.replaceScene(game.scenes.start);
                        //this.charChat.hide();
                    },
                    onEnterFrame: function(e) {
                        this.clock.onEnterFrame(e);
                        this.updateSkyColor();
                        this.timeElapsed = this.animateObjects(e.elapsed);
                        if(this.rightButtonDown) {
                            this.rotateObjects(-1 * this.worldRotationSpeed);
                            this.animateChar(e.elapsed);
                        } else if(this.leftButtonDown) {
                            this.rotateObjects(this.worldRotationSpeed);
                            this.animateChar(e.elapsed);
                        }
                        var npc = this.checkCollision();
                        if(npc !== null) {
                            npc.startEvent();
                        }
                    },
                    onRightButtonDown: function(e) {
                        if(!this.rightButtonDown) {
                            this.rightButtonDown = true;
                            //this.char.frame = [0,1,2,3,4,5,6,9,10,11];
                            this.char.turn(1);
                        }
                    },
                    onRightButtonUp: function(e) {
                        if(this.rightButtonDown) {
                            this.rightButtonDown = false;
                            this.char.frame = 0;
                        }
                    },
                    onLeftButtonDown: function(e) {
                        if(!this.leftButtonDown) {
                            this.leftButtonDown = true;
                            //this.char.frame = [0,1,2,3,4,5,6,9,10,11];
                            this.char.turn(-1);
                        }
                    },
                    onLeftButtonUp: function(e) {
                        if(this.leftButtonDown) {
                            this.leftButtonDown = false;
                            this.char.frame = 0;
                        }
                    }
                });
                
                var World = Class.create(Sprite, {
                   game: Game.instance,
                   initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        }
                        this.radius = width / 2;
                        this.scaleX = 1;
                        this.scaleY = 1;
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.y = -300;
                   }
                });
                
                var Character = Class.create(Sprite, {
                    game: Game.instance,
                    initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        } else {
                            this.image = game.assets['img/tipu_1000x732.gif'];
                            this.frame = [0,1,2,3,4,5,6,9,10,11];
                        }
                        
                        this.scaleX = 0.25;
                        this.scaleY = 0.25;
                        this.direction = 1;
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.y = 100;
                        this.mood = { happy: 0, angry: 0, sad: 0 };
                    },
                    turn: function(dir) {
                        if(this.direction !== dir) {
                            this.direction = -1 * this.direction;
                            this.scaleX = this.scaleX * -1;
                        }
                    },
                    onEnterFrame: function(e) {
                        //this.rotate(1);
                    }
                });
                
                var GameObject = Class.create(Sprite, {
                    game: Game.instance,
                    initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        }
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.scaleX = 0.1;
                        this.scaleY = 0.1;
                        this.distance = 1750;
                        this.event = null;
                    },
                    updatePosition: function(world) {
                        this.origX = world.x + world.width / 2 - this.width/2;
                        this.origY = world.y + world.height / 2 - this.height/2;
                        this.x = this.origX + this.distance * Math.sin(this.rotation * Math.PI / 180);
                        this.y = this.origY - this.distance * Math.cos(this.rotation * Math.PI / 180);
                    },
                    startEvent: function() {
                        if(this.event !== null && !this.event.started) {
                            this.event.showEvent(this);
                        }
                    }
                });
                var GameUIObject = Class.create(Sprite, {
                    game: Game.instance,
                    initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        }
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.scaleX = 0.5;
                        this.scaleY = 0.5;
                        this.distance = 2075;
                    },
                    updatePosition: function(world) {
                        this.origX = world.x + world.width / 2 - this.width/2;
                        this.origY = world.y + world.height / 2 - this.height/2;
                        this.x = this.origX + this.distance * Math.sin(this.rotation * Math.PI / 180);
                        this.y = this.origY - this.distance * Math.cos(this.rotation * Math.PI / 180);
                    },
                    onTouchStart: function(e) {
                        if(this.parent.option !== null && this.parent.event !== null) {
                            this.parent.event.showAnswer(this.parent.option);
                        } else if(this.parent.event !== null) {
                            this.parent.event.showOptions();
                        } else {
                            this.parent.hide();
                        }
                    }
                });
                
                var ChatBubble = function(scene, gameObject, text) {
                    this.scene = scene;
                    
                    this.option = null;
                    this.event = null;
                    
                    this.bubble = new GameUIObject(958, 465, 'img/kuplaW958.png');
                    this.bubble.scaleY = 0.3;
                    this.bubble.scaleX = 0.6;
                    this.bubble.distance = 2130;
                    this.bubble.rotate(gameObject.rotation);
                    this.bubble.parent = this;
                    this.chatLine = new GameUIObject(176, 280, 'img/viivaW176.png');
                    this.chatLine.rotate(gameObject.rotation - 1);
                    this.chatLine.distance = 1990;
                    this.chatLine.scaleY = 0.85;
                    this.text = new ChatLabel(text);
                    this.text.rotate(gameObject.rotation);
                    
                    this.bubble.addEventListener(Event.TOUCH_START, this.bubble.onTouchStart);
                    
                    this.setText = function(text) {
                        this.text.text = text;
                    };
                    
                    this.rotate = function(degrees) {
                        this.bubble.rotate(degrees);
                        this.chatLine.rotate(degrees);
                        this.text.rotate(degrees);
                    };
                    
                    this.updatePosition = function(world) {
                        this.bubble.origX = world.x + world.width / 2 - this.bubble.width/2;
                        this.bubble.origY = world.y + world.height / 2 - this.bubble.height/2;
                        this.chatLine.origX = world.x + world.width / 2 - this.chatLine.width/2;
                        this.chatLine.origY = world.y + world.height / 2 - this.chatLine.height/2;
                        this.text.origX = world.x + world.width / 2 - this.text.width/2;
                        this.text.origY = world.y + world.height / 2 - this.text.height/2;
                        this.bubble.x = this.bubble.origX + this.bubble.distance * Math.sin(this.bubble.rotation * Math.PI / 180);
                        this.bubble.y = this.bubble.origY - this.bubble.distance * Math.cos(this.bubble.rotation * Math.PI / 180);
                        this.chatLine.x = this.chatLine.origX + this.chatLine.distance * Math.sin(this.chatLine.rotation * Math.PI / 180);
                        this.chatLine.y = this.chatLine.origY - this.chatLine.distance * Math.cos(this.chatLine.rotation * Math.PI / 180);
                        this.text.x = this.text.origX + this.text.distance * Math.sin(this.text.rotation * Math.PI / 180);
                        this.text.y = this.text.origY - this.text.distance * Math.cos(this.text.rotation * Math.PI / 180);
                    };
                    
                    this.show = function() {
                        this.scene.addChild(this.bubble);
                        this.scene.addChild(this.chatLine);
                        this.scene.addChild(this.text);
                    };
                    
                    this.hide = function() {
                        this.scene.removeChild(this.bubble);
                        this.scene.removeChild(this.chatLine);
                        this.scene.removeChild(this.text);
                    };
                    
                    this.makeLower = function(i) {
                        if(typeof i == 'undefined') {
                            i = 1;
                        }
                        this.bubble.distance -= (100 * i);
                        this.chatLine.scaleY -= (0.4 * i);
                        this.chatLine.distance -= (60 * i);
                        this.text.distance -= (100 * i);
                        
                        this.updatePosition(Game.instance.currentScene.world);
                    };
                };
                
                var GameEvent = function() {
                    this.initialText = "";
                    this.options = new Array();
                    this.started = false;
                    this.gameObject = null;
                    
                    this.bubbles = new Array();
                    
                    this.showEvent = function(gameObject) {
                        var game = Game.instance;
                        this.started = true;
                        this.gameObject = gameObject;
                        
                        var chatBubble = new ChatBubble(game.currentScene, gameObject, this.initialText);
                        chatBubble.show();
                        chatBubble.event = this;
                        chatBubble.updatePosition(game.currentScene.world);
                        this.bubbles.push(chatBubble);
                        game.currentScene.ui.push(chatBubble);
                        
                    };
                    this.showOptions = function() {
                        var game = Game.instance;
                        this.closeBubbles();
                        for(var i=0;i<this.options.length; i++) {
                            var optionBubble = new ChatBubble(game.currentScene, game.currentScene.char, this.options[i].text);
                            optionBubble.event = this;
                            optionBubble.option = i;
                            optionBubble.show();
                            optionBubble.makeLower(i);
                            optionBubble.updatePosition(game.currentScene.world);
                            this.bubbles.push(optionBubble);
                        }
                    };
                    this.showAnswer = function(index) {
                        this.closeBubbles();
                        if(this.started && this.gameObject !== null) {
                            var game = Game.instance;
                            var answer = this.options[index].pickAnswer();
                            var answerBubble = new ChatBubble(game.currentScene, this.gameObject, answer.text);
                            answerBubble.show();
                            answerBubble.updatePosition(game.currentScene.world);
                            game.currentScene.ui.push(answerBubble);
                            game.currentScene.char.mood[answer.type] += answer.effect;
                            
                            console.log(game.currentScene.char.mood);
                        }
                    };
                    this.closeBubbles = function() {
                        for(var i=this.bubbles.length -1; i>=0; i--) {
                            this.bubbles[i].hide();
                            this.bubbles.splice(i, 1);
                        }
                    };
                };
                var Option = function(text) {
                    this.text = typeof text === 'string' ? text : "";
                    this.answers = new Array();
                    
                    this.pickAnswer = function() {
                        return this.answers[Math.floor(Math.random()*this.answers.length)];
                    };
                };
                var Answer = function(text, type, effect) {
                    this.text = typeof text === 'string' ? text : "";
                    this.type = typeof type === 'string' ? type : "neutral";
                    this.effect = typeof effect === 'number' ? effect : 0;
                };
                var Types = {
                    neutral: "neutral",
                    happy: "happy",
                    angry: "angry",
                    sad: "sad"
                };
                
                var ChatLabel = Class.create(Label, {
                    game: Game.instance,
                    initialize: function(text) {
                        Label.apply(this, [text]);
                        //this.text = text;
                        this.font = '24px Comic Sans MS';
                        this.color = 'black';
                        this.textAlign = 'left';
                        this.width = 500;
                        this.distance = 2160;
                        this.x = gamediv.width() / 2 - this.width / 2;
                    },
                    updatePosition: function(world) {
                        this.origX = world.x + world.width / 2 - this.width/2;
                        this.origY = world.y + world.height / 2 - this.height/2;
                        this.x = this.origX + this.distance * Math.sin(this.rotation * Math.PI / 180);
                        this.y = this.origY - this.distance * Math.cos(this.rotation * Math.PI / 180);
                    }
                });
                
                var TitleLabel = Class.create(Label, {
                    game: Game.instance,
                    initialize: function(text) {
                        Label.apply(this, [text]);
                        //this.text = text;
                        this.font = '32px Comic Sans MS';
                        this.color = 'green';
                        this.backgroundColor = '#000000';
                        this.textAlign = 'center';
                        this.width = text.length * 17;
                        this.x = gamediv.width() / 2 - this.width / 2;
                    }
                });
                
                var Clock = Class.create(Label, {
                    game: Game.instance,
                    initialize: function() {
                        Label.apply(this, ['00:00']);
                        
                        this.hours = 8;
                        this.minutes = 0;
                        this.time = 0;
                        
                        this.font = "32px Comic Sans MS";
                        
                        this.timeSpeed = 2;
                        this.updateClock();
                    },
                    updateClock: function() {
                        var hourText = this.hours > 9 ? this.hours : "0" + this.hours;
                        var minText = this.minutes > 9 ? this.minutes : "0" + this.minutes;
                        
                        this.text = hourText + ":" + minText;
                    },
                    onEnterFrame: function(e) {
                        this.time += e.elapsed * 0.001;
                        if(this.time >= this.timeSpeed) {
                            this.minutes = (this.minutes + 15) % 60;
                            if(this.minutes === 0) {
                                this.hours = (this.hours + 1) % 24;
                            }
                            this.time -= this.timeSpeed;
                            this.updateClock();
                        }
                    }
                });
            };
        </script>
    </body>
</html>
