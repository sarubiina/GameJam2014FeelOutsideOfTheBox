<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Feel Outside The Box</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="css/site.css" />
        <script type="text/javascript" src="js/enchant/enchant.js"></script>
        <script type="text/javascript" src="js/jquery/jquery-1.11.0.js"></script>
    </head>
    <body>
        <div id="header"><h1>Feel Outside The Box</h1></div>
        <hr />
        <div id="content">
            <div id="enchant-stage"></div>
        </div>
        <hr />
        <div id="footer">
            <ul>
                <li>
                    <span class="credits_title">Credits:</span>
                    <ul>
                        <li>Coded by <span class="credit">Katariina Pohjola</span> and <span class="credit">Nukiuchi</span></li>
                        <li>Graphics by <span class="credit">Muura</span> and <span class="credit">Myla</span></li>
                        <li>Audio by <span class="credit">Taneli</span> and <span class="credit">Markus</span></li>
                    </ul>
                </li>
            </ul>
        </div>
        <script type="text/javascript">
            var gamediv = $('#enchant-stage');
            window.onload = function() {
                enchant();
                
                var game = new Game(1024,600);
                game.preload('img/tipu_1000x732.gif', // Player Character
                             'img/tipu_idle_happy.png',
                             'img/tipuvihanen.gif',
                             'img/tipu_idle_angry.png',
                             'img/tipusurullinen.gif',
                             'img/tipu_idle_sad.png',
                             'img/kissa.png', // NPCs
                             'img/laatikkohahmoW526.png',
                             'img/koalaW917.png',
                             'img/roskisW930.png',
                             'img/mummo-619-x-850b.gif',
                             'img/kentta_5000.gif', // UI and other objects
                             'img/viivaW176.png',
                             'img/ajatusW142.png',
                             'img/kuplaW958.png',
                             'img/valinnat.png',
                             'img/title.gif', // Fullscreen images
                             'img/credits.gif',
                             'img/happydream.gif',
                             'img/saddream.gif',
                             'img/angrydream.gif',
                             /*'img/neutraldream.gif'*/
                             'audio/Angry_mood.mp3', // Audio
                             'audio/Happy_mood.mp3',
                             'audio/Rainy_mood.mp3',
                             'audio/Superb_mood.mp3');
                game.onload = function() {
                    game.scale = 1;
                    game.fps = 30;
                    game.scenes = new Object();
                    
                    var startScene = new StartScene();
                    game.scenes.start = startScene;
                    
                    game.pushScene(game.scenes.start);
                };
                
                game.start();
                
                var StartScene = Class.create(Scene, {
                    game: Game.instance,
                    initialize: function() {
                        Scene.apply(this);
                        
                        this.backgroundColor = '#aaaaaa';
                        /*
                        this.world = new World(5000, 5000, 'img/kentta_5000.gif');
                        this.addChild(this.world);
                        
                        this.title = new TitleLabel("Feel Outside The Box");
                        this.title.y = 50;
                        this.title.font = "32px Comic Sans MS";
                        this.addChild(this.title);
                        
                        this.subtitle = new TitleLabel("FGJ2014 - Pohjois-Karjala");
                        this.subtitle.y = 150;
                        this.subtitle.color = 'red';
                        this.addChild(this.subtitle);
                        
                        this.subtitle = new TitleLabel("Credits:\r\nNukiuchi, Katariina Pohjola, Muura, Myla");
                        this.subtitle.y = 250;
                        this.subtitle.color = 'blue';
                        this.addChild(this.subtitle);
                        
                        this.char = new Character(781,602);
                        this.addChild(this.char);
                        */
                        this.title = new Sprite(1024,600);
                        this.title.image = game.assets['img/title.gif'];
                        this.addChild(this.title);
                        
                        this.addEventListener(Event.TOUCH_START, this.onTouchStart);
                        this.addEventListener(Event.ENTER_FRAME, this.onEnterFrame);
                        
                        this.titleTime = 0;
                    },

                    onTouchStart: function(e) {
                        var gameScene = new GameScene();
                        game.replaceScene(gameScene);
                    },
                    onEnterFrame: function(e) {
                        //this.char.onEnterFrame(e);
                        //this.world.rotate(-0.1);
                        this.titleTime += e.elapsed * 0.001;
                        if(this.titleTime >= 0.15) {
                            this.title.frame++;
                            this.titleTime = 0;
                        }
                    }
                });
                
                var GameScene = Class.create(Scene, {
                    game: Game.instance,
                    initialize: function() {
                        Scene.apply(this);
                        
                        // Define the background or "world" object
                        this.world = new World(5000, 5000, 'img/kentta_5000.gif');
                        this.addChild(this.world);
                        this.originX = this.world.x;
                        this.backgroundColor = '#112255';
                        
                        // Define different GameObjects, or NPCs
                        this.npcs = new Array();
                        
                        var cat = new GameObject(765,1984, 'img/kissa.png');
                        cat.distance = 1760;
                        cat.rotate(15);
                        
                        var catEvent = new GameEvent();
                        catEvent.initialText = "Purrrrrrr.";
                        var option1 = new Option("Oh, please do not eat me...");
                        var o1_answer1 = new Answer("I am quite full, thank you very much.", Types.happy, 1);
                        var o1_answer2 = new Answer("You are not enough even for a snack.", Types.sad, 1);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("Ah, cats are so beautiful!");
                        var o2_answer1 = new Answer("I know. Sucks that you will never be as         beautiful as I am, huh?", Types.sad, 2);
                        var o2_answer2 = new Answer("Purrrr, and your wish was to pet me, yes?", Types.happy, 2);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("Why did the chicken cross the road?");
                        var o3_answer1 = new Answer("To get out of my sight, smelling like a hay-     stack in a ditch...", Types.angry, 1);
                        var o3_answer2 = new Answer("Better question is, why did you not?", Types.angry, 2);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        catEvent.options.push(option1);
                        catEvent.options.push(option2);
                        catEvent.options.push(option3);
                        
                        cat.event = catEvent;
                        this.addChild(cat);
                        this.npcs.push(cat);
                        
                        var coala = new GameObject(917,1084, 'img/koalaW917.png');
                        coala.distance = 1827;
                        coala.rotate(cat.rotation + 45);
                        
                        var coalaEvent = new GameEvent();
                        coalaEvent.initialText = "Cheers matey!";
                        var option1 = new Option("Hey, how's it going down in Australia?");
                        var o1_answer1 = new Answer("I dunno man, never been. Captive all my life.", Types.sad, 2);
                        var o1_answer2 = new Answer("I dunno man, never been. Go see for yerself if yer that interested.", Types.angry, 2);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("You're so cute!");
                        var o2_answer1 = new Answer("I know man, I know.", Types.happy, 1);
                        var o2_answer2 = new Answer("Ye think? Can't say the same from you,          though.", Types.angry, 2);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("Heh. Dropbears.");
                        var o3_answer1 = new Answer("Ha. Ha. So very funny. Not.", Types.angry, 2);
                        var o3_answer2 = new Answer("Ye think that's funny man, but my pa got      killed in a dropbear accident.", Types.sad, 2);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        coalaEvent.options.push(option1);
                        coalaEvent.options.push(option2);
                        coalaEvent.options.push(option3);
                        
                        coala.event = coalaEvent;
                        this.addChild(coala);
                        this.npcs.push(coala);
                        
                        var boxguy = new GameObject(526, 1373, 'img/laatikkohahmoW526.png');
                        boxguy.distance = 1820;
                        boxguy.rotate(coala.rotation + 50);
                        
                        var boxEvent = new GameEvent();
                        boxEvent.initialText = "Grrrr.";
                        var option1 = new Option("Hey chunkface!");
                        var o1_answer1 = new Answer("Ha! That's a good one!", Types.happy, 2);
                        var o1_answer2 = new Answer("Watch it, it ain't easy like this!", Types.angry, 1);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("Can I help you?");
                        var o2_answer1 = new Answer("Oh, you think you're SO HELPFUL now, do   you? Well la dee dah! Goody two shoes on theloose!", Types.angry, 2);
                        var o2_answer2 = new Answer("Oh you're one of those. Wanna help every-   one. Getting the good karma! Make everyone happy! Ain't you one bloody goody two            shoes...", Types.angry, 2);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("How come you're shaped like a box?");
                        var o3_answer1 = new Answer("I was born like this. Hard to fit in 'round     places. It's inside what counts, though.", Types.happy, 1);
                        var o3_answer2 = new Answer("I was born like this. Makes the life hard, no round place I could fit through.", Types.sad, 2);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        boxEvent.options.push(option1);
                        boxEvent.options.push(option2);
                        boxEvent.options.push(option3);
                        
                        boxguy.event = boxEvent;
                        this.addChild(boxguy);
                        this.npcs.push(boxguy);
                        
                        var trashbin = new GameObject(930, 1272, 'img/roskisW930.png');
                        trashbin.distance = 1808;
                        trashbin.rotate(boxguy.rotation + 50);
                        
                        var trashEvent = new GameEvent();
                        trashEvent.initialText = "...";
                        var option1 = new Option("<Kick it.>");
                        var o1_answer1 = new Answer("Ow! What'd you do that for, you bloody        idiot?!", Types.angry, 2);
                        var o1_answer2 = new Answer("Ahh, that hit the itch. Thanks dude!", Types.happy, 2);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("I'm so hungry... I wonder if there's anything there.");
                        var o2_answer1 = new Answer("Lots of yummy stuff in here. Old diapers      smell just delicious!", Types.sad, 1);
                        var o2_answer2 = new Answer("Like this hambuger that was dumped here     like couple minutes ago? Sorry, but my          lodgers already ate bites out of it.", Types.sad, 1);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("Oh, I should leave my candy wrappings here.");
                        var o3_answer1 = new Answer("Ooh, they smell delicious! Wait, is that what I think it is? Oh, it sure is, my favorite kind of candy crumbs!", Types.happy, 2);
                        var o3_answer2 = new Answer("I'm sorry, but I'm only for recycling bottles.Take your wrappings elsewhere.", Types.angry, 1);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        trashEvent.options.push(option1);
                        trashEvent.options.push(option2);
                        trashEvent.options.push(option3);
                        
                        trashbin.event = trashEvent;
                        this.addChild(trashbin);
                        this.npcs.push(trashbin);
                        
                        var granny = new GameObject(619, 850, 'img/mummo-619-x-850b.gif');
                        granny.distance = 1820;
                        granny.scaleX = 0.25;
                        granny.scaleY = 0.25;
                        granny.rotate(trashbin.rotation + 50);
                        
                        var grannyEvent = new GameEvent();
                        grannyEvent.initialText = "Hello there, youngin'!";
                        var option1 = new Option("Hello there, grandma. Need help crossing the street?");
                        var o1_answer1 = new Answer("Well I never! I still got spring in these         bones! I can cross a road or few just fine!", Types.angry, 2);
                        var o1_answer2 = new Answer("How dare you call me grandma, I still remem-ber my days as teenager like it was only        yesterday!", Types.angry, 1);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("Such a terrible weather.");
                        var o2_answer1 = new Answer("It sure is. Days like these, I'm glad I have    my vodka to keep my old achin' bones warm!", Types.happy, 2);
                        var o2_answer2 = new Answer("And thanks to whiny people like you it          doesn't get any better, either.", Types.angry, 2);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("What's on your mind?");
                        var o3_answer1 = new Answer("My dead wife, Pirkko... Oh Pirkko, you used to make me laugh so.", Types.sad, 2);
                        var o3_answer2 = new Answer("Life is so dark nowadays, without my trust- worthy dog Vuppe...", Types.sad, 2);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        grannyEvent.options.push(option1);
                        grannyEvent.options.push(option2);
                        grannyEvent.options.push(option3);
                        
                        granny.event = grannyEvent;
                        this.addChild(granny);
                        this.npcs.push(granny);
                        
                        var cat = new GameObject(765,1984, 'img/kissa.png');
                        cat.distance = 1760;
                        cat.rotate(granny.rotation + 50);
                        
                        var catEvent = new GameEvent();
                        catEvent.initialText = "Purrrrrrr.";
                        var option1 = new Option("Oh, please do not eat me...");
                        var o1_answer1 = new Answer("I am quite full, thank you very much.", Types.happy, 1);
                        var o1_answer2 = new Answer("You are not enough even for a snack.", Types.sad, 1);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("Ah, cats are so beautiful!");
                        var o2_answer1 = new Answer("I know. Sucks that you will never be as         beautiful as I am, huh?", Types.sad, 2);
                        var o2_answer2 = new Answer("Purrrr, and your wish was to pet me, yes?", Types.happy, 2);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("Why did the chicken cross the road?");
                        var o3_answer1 = new Answer("To get out of my sight, smelling like a hay-     stack in a ditch...", Types.angry, 1);
                        var o3_answer2 = new Answer("Better question is, why did you not?", Types.angry, 2);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        catEvent.options.push(option1);
                        catEvent.options.push(option2);
                        catEvent.options.push(option3);
                        
                        cat.event = catEvent;
                        this.addChild(cat);
                        this.npcs.push(cat);
                        
                        trashbin = new GameObject(930, 1272, 'img/roskisW930.png');
                        trashbin.distance = 1808;
                        trashbin.rotate(cat.rotation + 50);
                        
                        var trashEvent = new GameEvent();
                        trashEvent.initialText = "...";
                        var option1 = new Option("<Kick it.>");
                        var o1_answer1 = new Answer("Ow! What'd you do that for, you bloody        idiot?!", Types.angry, 2);
                        var o1_answer2 = new Answer("Ahh, that hit the itch. Thanks dude!", Types.happy, 2);
                        option1.answers.push(o1_answer1);
                        option1.answers.push(o1_answer2);
                        var option2 = new Option("I'm so hungry... I wonder if there's anything there.");
                        var o2_answer1 = new Answer("Lots of yummy stuff in here. Old diapers      smell just delicious!", Types.sad, 1);
                        var o2_answer2 = new Answer("Like this hambuger that was dumped here     like couple minutes ago? Sorry, but my          lodgers already ate bites out of it.", Types.sad, 1);
                        option2.answers.push(o2_answer1);
                        option2.answers.push(o2_answer2);
                        var option3 = new Option("Oh, I should leave my candy wrappings here.");
                        var o3_answer1 = new Answer("Ooh, they smell delicious! Wait, is that what I think it is? Oh, it sure is, my favorite kind of candy crumbs!", Types.happy, 2);
                        var o3_answer2 = new Answer("I'm sorry, but I'm only for recycling bottles.Take your wrappings elsewhere.", Types.angry, 1);
                        option3.answers.push(o3_answer1);
                        option3.answers.push(o3_answer2);
                        trashEvent.options.push(option1);
                        trashEvent.options.push(option2);
                        trashEvent.options.push(option3);
                        
                        trashbin.event = trashEvent;
                        this.addChild(trashbin);
                        this.npcs.push(trashbin);
                        
                        // Define the Player Character
                        this.char = new Character(781,602);
                        this.char.frame = [null];
                        this.addChild(this.char);
                        
                        // Define UI
                        this.clock = new Clock();
                        this.clock.timeSpeed = 3;
                        this.addChild(this.clock);
                        
                        // Define Game UI Objects
                        
                        this.ui = new Array();
                        
                        this.charChat = new ChatBubble(this, this.char, "What a nice morning! Let's go for a walk.       Click these bubbles to progress a discussion!");
                        this.charChat.show();
                        this.charChat.updatePosition(this.world);
                        
                        this.rightButton = new Button(this, ' - ->', this.onRightButtonDown, this.onRightButtonUp);
                        this.rightButton.setX(70);
                        this.rightButton.setY(480);
                        this.rightButton.show();
                        this.leftButton = new Button(this, '<- -', this.onLeftButtonDown, this.onLeftButtonUp);
                        this.leftButton.setX(-10);
                        this.leftButton.setY(480);
                        this.leftButton.show();
                        
                        // Event bindings
                        this.addEventListener(Event.TOUCH_START, this.onTouchStart);
                        this.addEventListener(Event.ENTER_FRAME, this.onEnterFrame);
                        this.addEventListener(Event.RIGHT_BUTTON_DOWN, this.onRightButtonDown);
                        this.addEventListener(Event.RIGHT_BUTTON_UP, this.onRightButtonUp);
                        this.addEventListener(Event.LEFT_BUTTON_DOWN, this.onLeftButtonDown);
                        this.addEventListener(Event.LEFT_BUTTON_UP, this.onLeftButtonUp);
                        
                        // Flags for input and timers
                        this.rightButtonDown = false;
                        this.leftButtonDown = false;
                        this.timeElapsedObjects = 0;
                        this.timeElapsedChar = 0;
                        this.timeElapsedEnd = 0;
                        
                        // Variables for game speed and such
                        this.charUpdateSpeed = 0.2;
                        this.objectUpdateSpeed = 0.1;
                        this.worldRotationSpeed = 0.15;
                        this.collisionDistance = 150;
                        this.endSpeed = 10;
                        
                        // Initialize objects
                        this.rotateObjects(0);
                        
                        this.bgm = game.assets['audio/Happy_mood.mp3'];
                        this.bgm.play();
                    },
                    updateSkyColor: function() {
                        var hours = this.clock.hours;
                        var mood = this.char.mood;
                        var moodMod;
                        if(mood.happy > mood.angry && mood.happy > mood.sad) {
                            moodMod = Types.happy;
                        } else if(mood.angry > mood.happy && mood.angry > mood.sad) {
                            moodMod = Types.angry;
                        } else if(mood.sad > mood.angry && mood.sad > mood.happy) {
                            moodMod = Types.sad;
                        } else {
                            moodMod = Types.neutral;
                        }
                        if(hours > 22 || hours < 6) {
                            // Night
                            if(moodMod == Types.angry) {
                                this.backgroundColor = '#330000';
                            } else if(moodMod == Types.sad) {
                                this.backgroundColor = '#030303';
                            } else {
                                this.backgroundColor = '#000011';
                            }
                        } else if(hours >= 6 && hours < 11) {
                            if(moodMod == Types.angry) {
                                switch(hours) {
                                case 6:
                                    this.backgroundColor = '#440000';
                                    break;
                                case 7:
                                    this.backgroundColor = '#660000';
                                    break;
                                case 8:
                                    this.backgroundColor = '#AA1100';
                                    break;
                                case 9:
                                    this.backgroundColor = '#CC1100';
                                    break;
                                case 10:
                                    this.backgroundColor = '#DD1100';
                                    break;
                            }
                            } else if(moodMod == Types.sad) {
                                switch(hours) {
                                case 6:
                                    this.backgroundColor = '#101010';
                                    break;
                                case 7:
                                    this.backgroundColor = '#222222';
                                    break;
                                case 8:
                                    this.backgroundColor = '#444444';
                                    break;
                                case 9:
                                    this.backgroundColor = '#777777';
                                    break;
                                case 10:
                                    this.backgroundColor = '#999999';
                                    break;
                            }
                            } else {
                                switch(hours) {
                                case 6:
                                    this.backgroundColor = '#111122';
                                    break;
                                case 7:
                                    this.backgroundColor = '#337777';
                                    break;
                                case 8:
                                    this.backgroundColor = '#559999';
                                    break;
                                case 9:
                                    this.backgroundColor = '#77BBBB';
                                    break;
                                case 10:
                                    this.backgroundColor = '#99DDDD';
                                    break;
                            }
                            }
                        } else if(hours >= 18 && hours <= 22) {
                            if(moodMod == Types.angry) {
                                switch(hours) {
                                    case 18:
                                        this.backgroundColor = '#DD1100';
                                        break;
                                    case 19:
                                        this.backgroundColor = '#CC1100';
                                        break;
                                    case 20:
                                        this.backgroundColor = '#AA1100';
                                        break;
                                    case 21:
                                        this.backgroundColor = '#660000';
                                        break;
                                    case 22:
                                        this.backgroundColor = '#440000';
                                        break;
                                }
                            } else if(moodMod == Types.sad) {
                                switch(hours) {
                                    case 18:
                                        this.backgroundColor = '#999999';
                                        break;
                                    case 19:
                                        this.backgroundColor = '#777777';
                                        break;
                                    case 20:
                                        this.backgroundColor = '#444444';
                                        break;
                                    case 21:
                                        this.backgroundColor = '#222222';
                                        break;
                                    case 22:
                                        this.backgroundColor = '#101010';
                                        break;
                                }
                            } else {
                                switch(hours) {
                                case 18:
                                    this.backgroundColor = '#99DDDD';
                                    break;
                                case 19:
                                    this.backgroundColor = '#77BBBB';
                                    break;
                                case 20:
                                    this.backgroundColor = '#559999';
                                    break;
                                case 21:
                                    this.backgroundColor = '#225555';
                                    break;
                                case 22:
                                    this.backgroundColor = '#111122';
                                    break;
                                }
                            }
                        } else {
                            // Day
                            if(moodMod == Types.angry) {
                                this.backgroundColor = '#DD1111';
                            } else if(moodMod == Types.sad) {
                                this.backgroundColor = '#AAAAAA';
                            } else {
                                this.backgroundColor = '#BBFFFF';
                            }
                        }
                    },
                    
                    rotateObjects: function(degrees) {
                        this.world.rotate(degrees);
                        for(var i=0;i<this.npcs.length; i++) {
                            this.npcs[i].rotate(degrees);
                            this.npcs[i].updatePosition(this.world);
                        }
                        for(i=0;i<this.ui.length; i++) {
                            this.ui[i].rotate(degrees);
                            this.ui[i].updatePosition(this.world);
                        }
                    },
                    
                    animateObjects: function(elapsed) {
                        this.timeElapsedObjects += elapsed * 0.001;
                        if(this.timeElapsedObjects >= this.objectUpdateSpeed) {
                            for(var i=0;i<this.npcs.length; i++) {
                                this.npcs[i].frame++;
                            }
                            this.timeElapsedObjects -= this.objectUpdateSpeed;
                        }
                    },
                    
                    animateChar: function(elapsed) {
                        this.timeElapsedChar += elapsed * 0.001;
                        if(this.timeElapsedChar >= this.charUpdateSpeed) {
                            this.char.frame++;
                            this.timeElapsedChar -= this.charUpdateSpeed;
                        }
                    },
                    checkCollision: function() {
                        for(var i=0;i<this.npcs.length;i++) {
                            if(this.char.within(this.npcs[i], this.collisionDistance)) {
                                return this.npcs[i];
                            }
                        }
                        return null;
                    },
                    onTouchStart: function(e) {
                        //game.replaceScene(game.scenes.start);
                        //this.charChat.hide();
                    },
                    onEnterFrame: function(e) {
                        //Update clock
                        this.clock.onEnterFrame(e);
                        
                        // Update sky
                        this.updateSkyColor();
                        
                        // Move world and objects
                        this.timeElapsed = this.animateObjects(e.elapsed);
                        if(this.rightButtonDown) {
                            this.rotateObjects(-1 * this.worldRotationSpeed);
                        } else if(this.leftButtonDown) {
                            this.rotateObjects(this.worldRotationSpeed);
                        }
                        this.animateChar(e.elapsed);
                        
                        // Check for NPC nearby
                        var npc = this.checkCollision();
                        if(npc !== null) {
                            npc.startEvent();
                        }
                        
                        // End timer
                        if(this.char.events >= 7) {
                            this.timeElapsedEnd += e.elapsed * 0.001;
                            if(this.timeElapsedEnd >= this.endSpeed) {
                                var endScene = new EndScene(this.char.mood);
                                this.game.replaceScene(endScene);
                            }
                        }
                        
                        // Background music loop
                        if(this.bgm.currentTime >= this.bgm.duration) {
                            this.bgm.stop();
                            this.bgm.play();
                        } else if(this.bgm != game.assets['audio/Rainy_mood.mp3'] && this.bgm.currentTime >= this.bgm.duration -1) {
                            this.bgm.stop();
                            this.bgm.play();
                        }
                    },
                    onRightButtonDown: function(e) {
                        var scene = game.currentScene;
                        if(!scene.rightButtonDown) {
                            scene.rightButtonDown = true;
                            //this.char.frame = [0,1,2,3,4,5,6,9,10,11];
                            switch(scene.char.moodMod) {
                                case Types.happy:
                                case Types.neutral:
                                    scene.char.image = game.assets['img/tipu_1000x732.gif'];
                                    scene.charUpdateSpeed = 0.01;
                                    break;
                                case Types.angry:
                                    scene.char.image = game.assets['img/tipuvihanen.gif'];
                                    scene.charUpdateSpeed = 0.01;
                                    break;
                                case Types.sad:
                                    scene.char.image = game.assets['img/tipusurullinen.gif'];
                                    scene.charUpdateSpeed = 0.01;
                                    break;
                            }
                            scene.char.turn(1);
                        }
                    },
                    onRightButtonUp: function(e) {
                        var scene = game.currentScene;
                        if(scene.rightButtonDown) {
                            scene.rightButtonDown = false;
                            switch(scene.char.moodMod) {
                                case Types.happy:
                                case Types.neutral:
                                    scene.char.image = game.assets['img/tipu_idle_happy.png'];
                                    scene.charUpdateSpeed = 0.2;
                                    break;
                                case Types.angry:
                                    scene.char.image = game.assets['img/tipu_idle_angry.png'];
                                    scene.charUpdateSpeed = 0.2;
                                    break;
                                case Types.sad:
                                    scene.char.image = game.assets['img/tipu_idle_sad.png'];
                                    scene.charUpdateSpeed = 0.2;
                                    break;
                            }
                            //scene.char.frame = 0;
                        }
                    },
                    onLeftButtonDown: function(e) {
                        var scene = game.currentScene;
                        if(!scene.leftButtonDown) {
                            scene.leftButtonDown = true;
                            switch(scene.char.moodMod) {
                                case Types.happy:
                                case Types.neutral:
                                    scene.char.image = game.assets['img/tipu_1000x732.gif'];
                                    scene.charUpdateSpeed = 0.01;
                                    break;
                                case Types.angry:
                                    scene.char.image = game.assets['img/tipuvihanen.gif'];
                                    scene.charUpdateSpeed = 0.01;
                                    break;
                                case Types.sad:
                                    scene.char.image = game.assets['img/tipusurullinen.gif'];
                                    scene.charUpdateSpeed = 0.01;
                                    break;
                            }
                            //this.char.frame = [0,1,2,3,4,5,6,9,10,11];
                            scene.char.turn(-1);
                        }
                    },
                    onLeftButtonUp: function(e) {
                        var scene = game.currentScene;
                        if(scene.leftButtonDown) {
                            scene.leftButtonDown = false;
                            switch(scene.char.moodMod) {
                                case Types.happy:
                                case Types.neutral:
                                    scene.char.image = game.assets['img/tipu_idle_happy.png'];
                                    scene.charUpdateSpeed = 0.1;
                                    break;
                                case Types.angry:
                                    scene.char.image = game.assets['img/tipu_idle_angry.png'];
                                    scene.charUpdateSpeed = 0.1;
                                    break;
                                case Types.sad:
                                    scene.char.image = game.assets['img/tipu_idle_sad.png'];
                                    scene.charUpdateSpeed = 0.1;
                                    break;
                            }
                            //scene.char.frame = 0;
                        }
                    }
                });
                
                var EndScene = Class.create(Scene, {
                    game: Game.instance,
                    initialize: function(mood) {
                        Scene.apply(this);
                        this.dream = new Sprite(1024,600);
                        
                        if(mood.happy > mood.angry && mood.happy > mood.sad) {
                            this.dream.image = game.assets['img/happydream.gif'];
                            game.currentScene.bgm.stop();
                            this.bgm = game.assets['audio/Happy_mood.mp3'];
                            this.bgm.play();
                        } else if(mood.angry > mood.happy && mood.angry > mood.sad) {
                            this.dream.image = game.assets['img/angrydream.gif'];
                            game.currentScene.bgm.stop();
                            this.bgm = game.assets['audio/Angry_mood.mp3'];
                            this.bgm.play();
                        } else if(mood.sad > mood.angry && mood.sad > mood.happy) {
                            this.dream.image = game.assets['img/saddream.gif'];
                            game.currentScene.bgm.stop();
                            this.bgm = game.assets['audio/Rainy_mood.mp3'];
                            this.bgm.play();
                        } else {
                            this.dream.image = game.assets['img/happydream.gif'];
                            game.currentScene.bgm.stop();
                        }
                        
                        this.addChild(this.dream);
                        
                        this.addEventListener(Event.ENTER_FRAME, this.onFrameEntered);
                        this.addEventListener(Event.TOUCH_START, this.onTouchStart);
                        
                        this.timeElapsed = 0;
                    },
                    onFrameEntered: function(e) {
                        this.timeElapsed += e.elapsed * 0.001;
                        if(this.timeElapsed >= 0.15) {
                            this.dream.frame++;
                            this.timeElapsed = 0;
                        }
                        
                        // Background music loop
                        if(this.bgm != null && this.bgm.currentTime >= this.bgm.duration) {
                            this.bgm.stop();
                            this.bgm.play();
                        } else if(this.bgm != game.assets['audio/Rainy_mood.mp3'] && this.bgm.currentTime >= this.bgm.duration -1) {
                            this.bgm.stop();
                            this.bgm.play();
                        }
                    },
                    onTouchStart: function(e) {
                        var creditsScene = new CreditsScene();
                        this.bgm.stop();
                        this.game.replaceScene(creditsScene);
                    }
                });
                var CreditsScene = Class.create(Scene, {
                    game: Game.instance,
                    initialize: function() {
                        Scene.apply(this);
                        this.credits = new Sprite(1024,600);
                        
                        this.credits.image = game.assets['img/credits.gif'];
                        
                        this.addChild(this.credits);
                        
                        this.addEventListener(Event.ENTER_FRAME, this.onFrameEntered);
                        this.addEventListener(Event.TOUCH_START, this.onTouchStart);
                        
                        this.timeElapsed = 0;
                        
                        this.bgm = game.assets['audio/Superb_mood.mp3'];
                        this.bgm.play();
                    },
                    onFrameEntered: function(e) {
                        this.timeElapsed += e.elapsed * 0.001;
                        if(this.timeElapsed >= 0.15) {
                            this.credits.frame++;
                            this.timeElapsed = 0;
                        }
                        
                        // Background music loop
                        if(this.bgm.currentTime >= this.bgm.duration) {
                            this.bgm.stop();
                            this.bgm.play();
                        }
                    },
                    onTouchStart: function(e) {
                        //var startScene = new StartScene();
                        //this.game.replaceScene(startScene);
                    }
                });
                
                var World = Class.create(Sprite, {
                   game: Game.instance,
                   initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        }
                        this.radius = width / 2;
                        this.scaleX = 1;
                        this.scaleY = 1;
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.y = -300;
                   }
                });
                
                var Character = Class.create(Sprite, {
                    game: Game.instance,
                    initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        } else {
                            this.image = game.assets['img/tipu_idle_happy.png'];
                            this.frame = [0,1,2,3,4,5,6,9,10,11];
                        }
                        
                        this.scaleX = 0.15;
                        this.scaleY = 0.15;
                        this.direction = 1;
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.y = 140;
                        this.mood = { happy: 0, angry: 0, sad: 0 };
                        this.events = 0;
                        
                        this.moodMod = 'neutral';
                    },
                    turn: function(dir) {
                        if(this.direction !== dir) {
                            this.direction = -1 * this.direction;
                            this.scaleX = this.scaleX * -1;
                        }
                    },
                    onEnterFrame: function(e) {
                        //this.rotate(1);
                    }
                });
                
                var GameObject = Class.create(Sprite, {
                    game: Game.instance,
                    initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        }
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.scaleX = 0.15;
                        this.scaleY = 0.15;
                        this.distance = 1750;
                        this.event = null;
                    },
                    updatePosition: function(world) {
                        this.origX = world.x + world.width / 2 - this.width/2;
                        this.origY = world.y + world.height / 2 - this.height/2;
                        this.x = this.origX + this.distance * Math.sin(this.rotation * Math.PI / 180);
                        this.y = this.origY - this.distance * Math.cos(this.rotation * Math.PI / 180);
                    },
                    startEvent: function() {
                        if(this.event !== null && !this.event.started) {
                            this.event.showEvent(this);
                            this.game.currentScene.char.events++;
                        }
                    }
                });
                var GameUIObject = Class.create(Sprite, {
                    game: Game.instance,
                    initialize: function(width, height, image) {
                        Sprite.apply(this, [width, height]);
                        if(typeof image === 'string') {
                            this.image = game.assets[image];
                        } else if(typeof image === 'object') {
                            this.image = image;
                        }
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.scaleX = 0.5;
                        this.scaleY = 0.5;
                        this.distance = 2075;
                    },
                    updatePosition: function(world) {
                        this.origX = world.x + world.width / 2 - this.width/2;
                        this.origY = world.y + world.height / 2 - this.height/2;
                        this.x = this.origX + this.distance * Math.sin(this.rotation * Math.PI / 180);
                        this.y = this.origY - this.distance * Math.cos(this.rotation * Math.PI / 180);
                    },
                    onTouchStart: function(e) {
                        if(this.parent.option !== null && this.parent.event !== null) {
                            this.parent.event.showAnswer(this.parent.option);
                        } else if(this.parent.event !== null) {
                            this.parent.event.showOptions();
                        } else {
                            this.parent.hide();
                        }
                    }
                });
                
                var ChatBubble = function(scene, gameObject, text) {
                    this.scene = scene;
                    
                    this.option = null;
                    this.event = null;
                    
                    this.bubble = new GameUIObject(958, 465, 'img/kuplaW958.png');
                    this.bubble.scaleY = 0.3;
                    this.bubble.scaleX = 0.6;
                    this.bubble.distance = 2130;
                    this.bubble.rotate(gameObject.rotation);
                    this.bubble.parent = this;
                    this.chatLine = new GameUIObject(176, 280, 'img/viivaW176.png');
                    this.chatLine.rotate(gameObject.rotation - 1);
                    this.chatLine.distance = 1995;
                    this.chatLine.scaleY = 0.8;
                    this.chatLine.parent = this;
                    this.text = new ChatLabel(text);
                    this.text.rotate(gameObject.rotation);
                    this.text.parent = this;
                    
                    this.bubble.addEventListener(Event.TOUCH_START, this.bubble.onTouchStart);
                    this.chatLine.addEventListener(Event.TOUCH_START, this.chatLine.onTouchStart);
                    this.text.addEventListener(Event.TOUCH_START, this.text.onTouchStart);
                    
                    this.setText = function(text) {
                        this.text.text = text;
                    };
                    
                    this.rotate = function(degrees) {
                        this.bubble.rotate(degrees);
                        this.chatLine.rotate(degrees);
                        this.text.rotate(degrees);
                    };
                    
                    this.updatePosition = function(world) {
                        this.bubble.origX = world.x + world.width / 2 - this.bubble.width/2;
                        this.bubble.origY = world.y + world.height / 2 - this.bubble.height/2;
                        this.chatLine.origX = world.x + world.width / 2 - this.chatLine.width/2;
                        this.chatLine.origY = world.y + world.height / 2 - this.chatLine.height/2;
                        this.text.origX = world.x + world.width / 2 - this.text.width/2;
                        this.text.origY = world.y + world.height / 2 - this.text.height/2;
                        this.bubble.x = this.bubble.origX + this.bubble.distance * Math.sin(this.bubble.rotation * Math.PI / 180);
                        this.bubble.y = this.bubble.origY - this.bubble.distance * Math.cos(this.bubble.rotation * Math.PI / 180);
                        this.chatLine.x = this.chatLine.origX + this.chatLine.distance * Math.sin(this.chatLine.rotation * Math.PI / 180);
                        this.chatLine.y = this.chatLine.origY - this.chatLine.distance * Math.cos(this.chatLine.rotation * Math.PI / 180);
                        this.text.x = this.text.origX + this.text.distance * Math.sin(this.text.rotation * Math.PI / 180);
                        this.text.y = this.text.origY - this.text.distance * Math.cos(this.text.rotation * Math.PI / 180);
                    };
                    
                    this.show = function() {
                        this.scene.addChild(this.bubble);
                        this.scene.addChild(this.chatLine);
                        this.scene.addChild(this.text);
                    };
                    
                    this.hide = function() {
                        this.scene.removeChild(this.bubble);
                        this.scene.removeChild(this.chatLine);
                        this.scene.removeChild(this.text);
                    };
                    
                    this.makeOption = function(i) {
                        if(typeof i == 'undefined') {
                            i = 1;
                        }
                        this.hide();
                        this.bubble = new GameUIObject(957, 171, 'img/valinnat.png');
                        this.bubble.scaleY = 0.4;
                        this.bubble.scaleX = 0.7;
                        this.bubble.distance = 2130;
                        this.bubble.rotate(gameObject.rotation);
                        this.bubble.parent = this;
                        this.bubble.distance -= (50 * i);
                        
                        this.chatLine = new GameUIObject(142, 196, 'img/ajatusW142.png');
                        this.chatLine.rotate(gameObject.rotation - 1);
                        this.chatLine.distance = 1930;
                        this.chatLine.scaleY = 0.8;
                        this.chatLine.parent = this;
                        this.chatLine.scaleY = i > 0 ? 0 : this.chatLine.scaleY;
                        this.text.distance -= (50 * i) +15;
                        this.text.width += 100;
                        
                        this.bubble.addEventListener(Event.TOUCH_START, this.bubble.onTouchStart);
                        
                        this.show();
                        this.updatePosition(Game.instance.currentScene.world);
                    };
                };
                
                var GameEvent = function() {
                    this.initialText = "";
                    this.options = new Array();
                    this.started = false;
                    this.gameObject = null;
                    
                    this.bubbles = new Array();
                    
                    this.showEvent = function(gameObject) {
                        var game = Game.instance;
                        this.started = true;
                        this.gameObject = gameObject;
                        
                        var chatBubble = new ChatBubble(game.currentScene, gameObject, this.initialText);
                        chatBubble.show();
                        chatBubble.event = this;
                        chatBubble.updatePosition(game.currentScene.world);
                        this.bubbles.push(chatBubble);
                        game.currentScene.ui.push(chatBubble);
                        
                    };
                    this.showOptions = function() {
                        var game = Game.instance;
                        this.closeBubbles();
                        for(var i=0;i<this.options.length; i++) {
                            var optionBubble = new ChatBubble(game.currentScene, game.currentScene.char, this.options[i].text);
                            optionBubble.event = this;
                            optionBubble.option = i;
                            optionBubble.show();
                            optionBubble.makeOption(i);
                            optionBubble.updatePosition(game.currentScene.world);
                            this.bubbles.push(optionBubble);
                        }
                    };
                    this.showAnswer = function(index) {
                        this.closeBubbles();
                        if(this.started && this.gameObject !== null) {
                            var game = Game.instance;
                            var answer = this.options[index].pickAnswer();
                            var answerBubble = new ChatBubble(game.currentScene, this.gameObject, answer.text);
                            answerBubble.updatePosition(game.currentScene.world);
                            answerBubble.show();
                            game.currentScene.ui.push(answerBubble);
                            game.currentScene.char.mood[answer.type] += answer.effect;
                            game.currentScene.char.moodMod = answer.type;
                            
                            switch(answer.type) {
                                case Types.happy:
                                    game.currentScene.char.image = game.assets['img/tipu_idle_happy.png'];
                                    game.currentScene.charUpdateSpeed = 0.2;
                                    if(game.currentScene.bgm == game.assets['audio/Happy_mood.mp3']) {
                                        game.currentScene.bgm.stop();
                                        game.currentScene.bgm = game.assets['audio/Superb_mood.mp3'];
                                        game.currentScene.bgm.play();
                                    } else if (game.currentScene.bgm != game.assets['audio/Superb_mood.mp3']){
                                        game.currentScene.bgm.stop();
                                        game.currentScene.bgm = game.assets['audio/Happy_mood.mp3'];
                                        game.currentScene.bgm.play();
                                    }
                                    break;
                                case Types.angry:
                                    game.currentScene.char.image = game.assets['img/tipu_idle_angry.png'];
                                    game.currentScene.charUpdateSpeed = 0.2;
                                    if(game.currentScene.bgm != game.assets['audio/Angry_mood.mp3']) {
                                        game.currentScene.bgm.stop();
                                        game.currentScene.bgm = game.assets['audio/Angry_mood.mp3'];
                                        game.currentScene.bgm.play();
                                    }
                                    break;
                                case Types.sad:
                                    game.currentScene.char.image = game.assets['img/tipu_idle_sad.png'];
                                    game.currentScene.charUpdateSpeed = 0.2;
                                    if(game.currentScene.bgm != game.assets['audio/Rainy_mood.mp3']) {
                                        game.currentScene.bgm.stop();
                                        game.currentScene.bgm = game.assets['audio/Rainy_mood.mp3'];
                                        game.currentScene.bgm.play();
                                    }
                                    break;
                            }
                            
                            console.log(game.currentScene.char.mood);
                        }
                    };
                    this.closeBubbles = function() {
                        for(var i=this.bubbles.length -1; i>=0; i--) {
                            this.bubbles[i].hide();
                            this.bubbles.splice(i, 1);
                        }
                    };
                };
                var Option = function(text) {
                    this.text = typeof text === 'string' ? text : "";
                    this.answers = new Array();
                    
                    this.pickAnswer = function() {
                        return this.answers[Math.floor(Math.random()*this.answers.length)];
                    };
                };
                var Answer = function(text, type, effect) {
                    this.text = typeof text === 'string' ? text : "";
                    this.type = typeof type === 'string' ? type : "neutral";
                    this.effect = typeof effect === 'number' ? effect : 0;
                };
                var Types = {
                    neutral: "neutral",
                    happy: "happy",
                    angry: "angry",
                    sad: "sad"
                };
                
                var ChatLabel = Class.create(Label, {
                    game: Game.instance,
                    initialize: function(text) {
                        Label.apply(this, [text]);
                        //this.text = text;
                        this.font = '24px Comic Sans MS';
                        this.color = 'black';
                        this.textAlign = 'left';
                        this.width = 500;
                        this.distance = 2160;
                        this.x = gamediv.width() / 2 - this.width / 2;
                        this.parent = null;
                    },
                    updatePosition: function(world) {
                        this.origX = world.x + world.width / 2 - this.width/2;
                        this.origY = world.y + world.height / 2 - this.height/2;
                        this.x = this.origX + this.distance * Math.sin(this.rotation * Math.PI / 180);
                        this.y = this.origY - this.distance * Math.cos(this.rotation * Math.PI / 180);
                    },
                    onTouchStart: function(e) {
                        if(this.parent.option !== null && this.parent.event !== null) {
                            this.parent.event.showAnswer(this.parent.option);
                        } else if(this.parent.event !== null) {
                            this.parent.event.showOptions();
                        } else {
                            this.parent.hide();
                        }
                    }
                });
                
                var Button = Class.create(Sprite, {
                    game: Game.instance,
                    initialize: function(scene, text, startAction, endAction) {
                        Sprite.apply(this, [957,171]);
                        this.scene = scene;
                        this.image = game.assets['img/valinnat.png'];
                        this.scaleX = 0.07;
                        this.scaleY = 0.4;
                        this.label = new TitleLabel(text);
                        
                        this.label.x = this.x + this.width / 2 - 40;
                        this.label.y = this.y + this.height / 2 - 20;
                        
                        this.addEventListener(Event.TOUCH_START, startAction);
                        this.addEventListener(Event.TOUCH_END, endAction);
                        this.label.addEventListener(Event.TOUCH_START, startAction);
                        this.label.addEventListener(Event.TOUCH_END, endAction);
                    },
                    show: function() {
                        this.scene.addChild(this);
                        this.scene.addChild(this.label);
                    },
                    
                    hide: function() {
                        this.scene.removeChild(this);
                        this.scene.removeChild(this.label);
                    },
                    setX: function(x) {
                        this.x = x;
                        this.label.x = this.x + this.width / 2 - 40;
                        
                    },
                    setY: function(y) {
                        this.y = y;
                        this.label.y = this.y + this.height / 2 - 20;
                    }
                });
                
                var TitleLabel = Class.create(Label, {
                    game: Game.instance,
                    initialize: function(text) {
                        Label.apply(this, [text]);
                        //this.text = text;
                        this.font = '24px Comic Sans MS';
                        this.color = 'black';
                        this.backgroundColor = '#000000';
                        this.textAlign = 'center';
                        this.width = text.length * 17;
                        this.x = gamediv.width() / 2 - this.width / 2;
                    }
                });
                
                var Clock = Class.create(Label, {
                    game: Game.instance,
                    initialize: function() {
                        Label.apply(this, ['']);
                        
                        this.x = 10;
                        
                        this.hours = 8;
                        this.minutes = 0;
                        this.time = 0;
                        
                        this.font = "32px Comic Sans MS";
                        
                        this.timeSpeed = 2;
                        this.updateClock();
                    },
                    updateClock: function() {
                        var hourText = this.hours > 9 ? this.hours : "0" + this.hours;
                        var minText = this.minutes > 9 ? this.minutes : "0" + this.minutes;
                        
                        //this.text = hourText + ":" + minText;
                    },
                    onEnterFrame: function(e) {
                        this.time += e.elapsed * 0.001;
                        if(this.time >= this.timeSpeed) {
                            this.minutes = (this.minutes + 15) % 60;
                            if(this.minutes === 0) {
                                this.hours = (this.hours + 1) % 24;
                            }
                            this.time = 0;
                            this.updateClock();
                        }
                    }
                });
            };
        </script>
    </body>
</html>
